<app-header mode="compact"></app-header>

<div class="circuit-form-container">
  <div class="form-card">
    <h1 class="form-title">Cr√©er un nouveau circuit</h1>
    
    <!-- Indicateur d'√©tape -->
    <div class="steps-indicator">
      <div class="step-item" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
        <div class="step-circle">
          <span class="step-icon" *ngIf="currentStep <= 1">1</span>
          <span class="step-icon" *ngIf="currentStep > 1">&#10003;</span>
        </div>
        <div class="step-label">Informations</div>
      </div>
      <div class="step-divider" [class.completed]="currentStep > 1"></div>
      <div class="step-item" [class.active]="currentStep === 2" [class.completed]="currentStep > 2" (click)="goToStep(2)">
        <div class="step-circle">
          <span class="step-icon" *ngIf="currentStep <= 2">2</span>
          <span class="step-icon" *ngIf="currentStep > 2">&#10003;</span>
        </div>
        <div class="step-label">M√©dias</div>
      </div>
      <div class="step-divider" [class.completed]="currentStep > 2"></div>
      <div class="step-item" [class.active]="currentStep === 3" (click)="goToStep(3)">
        <div class="step-circle">
          <span class="step-icon">3</span>
        </div>
        <div class="step-label">D√©tails</div>
      </div>
    </div>

    <!-- Message d'erreur global -->
    <div class="error-banner" *ngIf="errors['submit']">
      <span>‚ö†Ô∏è {{ errors['submit'] }}</span>
    </div>

    <form (ngSubmit)="onSubmit()">
      
      <!-- √âTAPE 1 : INFORMATIONS DE BASE -->
      <div class="step-content" *ngIf="currentStep === 1">
        <h2>Informations de base</h2>

        <div class="form-grid">
          <div class="form-group full-width">
            <label>Titre du circuit *</label>
            <input 
              type="text" 
              [(ngModel)]="circuit.titre" 
              name="titre"
              placeholder="Ex: D√©couverte du patrimoine royal"
              [class.error]="errors['titre']">
            <span class="error-text" *ngIf="errors['titre']">{{ errors['titre'] }}</span>
          </div>

          <div class="form-group full-width">
            <label>Description *</label>
            <textarea 
              [(ngModel)]="circuit.description" 
              name="description"
              rows="4"
              placeholder="D√©crivez le circuit de mani√®re d√©taill√©e..."
              [class.error]="errors['description']"></textarea>
            <span class="error-text" *ngIf="errors['description']">{{ errors['description'] }}</span>
          </div>

          <div class="form-group">
            <label>Dur√©e (jours) *</label>
            <input 
              type="number" 
              [(ngModel)]="circuit.dureeJours" 
              name="duree"
              min="1"
              max="30"
              (ngModelChange)="onDureeChange()"
              [class.error]="errors['duree']">
            <span class="error-text" *ngIf="errors['duree']">{{ errors['duree'] }}</span>
          </div>

          <div class="form-group">
            <label>Prix (EUR) *</label>
            <input 
              type="number" 
              [(ngModel)]="circuit.prixEuros" 
              name="prix"
              min="0"
              step="10"
              placeholder="0"
              [class.error]="errors['prix']">
            <span class="error-text" *ngIf="errors['prix']">{{ errors['prix'] }}</span>
          </div>

          <!-- Zone et ville supprim√©s de l'√©tape 1 - maintenant dans le programme -->
        </div>
      </div>

      <!-- √âTAPE 2 : M√âDIAS -->
      <div class="step-content" *ngIf="currentStep === 2">
        <h2>Images du circuit</h2>

        <div class="media-section">
          <div class="form-group">
            <label>Image principale *</label>
            <div class="file-upload-area" [class.has-file]="previewHero">
              <input 
                type="file" 
                accept="image/*"
                (change)="onHeroSelect($event)"
                #heroInput>
              <div class="upload-placeholder" *ngIf="!previewHero" (click)="heroInput.click()">
                <span class="upload-icon">üì∑</span>
                <span>Cliquez pour s√©lectionner l'image</span>
              </div>
              <img *ngIf="previewHero" [src]="previewHero" alt="Aper√ßu" class="preview-image">
            </div>
            <span class="error-text" *ngIf="errors['hero']">{{ errors['hero'] }}</span>
          </div>

          <div class="form-group full-width">
            <label>Galerie (3-10 images) *</label>
            <div class="file-upload-area">
              <input 
                type="file" 
                accept="image/*"
                multiple
                (change)="onGalerieSelect($event)"
                #galerieInput>
              <div class="upload-placeholder" (click)="galerieInput.click()">
                <span class="upload-icon">üñºÔ∏è</span>
                <span>S√©lectionnez entre 3 et 10 images</span>
              </div>
            </div>
            <div class="preview-grid" *ngIf="previewsGalerie.length > 0">
              <img *ngFor="let preview of previewsGalerie" [src]="preview" alt="Aper√ßu" class="preview-thumb">
            </div>
            <span class="hint" *ngIf="circuit.imagesGalerie.length > 0">
              {{ circuit.imagesGalerie.length }} image(s) s√©lectionn√©e(s)
            </span>
            <span class="error-text" *ngIf="errors['galerie']">{{ errors['galerie'] }}</span>
          </div>
        </div>
      </div>

      <!-- √âTAPE 3 : D√âTAILS -->
      <div class="step-content" *ngIf="currentStep === 3">
        <h2>Programme et details</h2>

        <div class="step3-tabs" role="tablist" aria-label="Sections etape 3">
          <button type="button" class="step3-tab" [class.open]="step3Section === 'programme'" (click)="setStep3Section('programme')">
            Programme
          </button>
          <button type="button" class="step3-tab" [class.open]="step3Section === 'highlights'" (click)="setStep3Section('highlights')">
            Points forts
          </button>
          <button type="button" class="step3-tab" [class.open]="step3Section === 'inclusions'" (click)="setStep3Section('inclusions')">
            Inclus / Non inclus
          </button>
        </div>

        <div class="step3-panel" *ngIf="step3Section === 'programme'">
          <div class="programme-head">
            <h3>Programme ({{ circuit.dureeJours }} jour{{ circuit.dureeJours > 1 ? 's' : '' }})</h3>
            <div class="day-nav-inline" *ngIf="circuit.programme.length > 1">
              <button type="button" class="day-nav-btn" (click)="goPrevDay()" [disabled]="activeDayIndex === 0">Prec.</button>
              <span class="day-nav-current">Jour {{ activeDayIndex + 1 }} / {{ circuit.programme.length }}</span>
              <button type="button" class="day-nav-btn" (click)="goNextDay()" [disabled]="activeDayIndex >= circuit.programme.length - 1">Suiv.</button>
            </div>
          </div>

          <div class="day-pills" *ngIf="circuit.programme.length > 1">
            <button
              type="button"
              class="day-pill"
              *ngFor="let jour of circuit.programme; let i = index"
              [class.active]="i === activeDayIndex"
              [class.complete]="getDayCompletion(i) === 3"
              (click)="selectDay(i)">
              J{{ i + 1 }}
            </button>
          </div>

          <div class="jour-card" *ngIf="circuit.programme[activeDayIndex] as day">
            <h4>Jour {{ day.jour }}</h4>

            <div class="jour-location">
              <div class="form-group">
                <label>Zone du jour {{ day.jour }}</label>
                <select
                  [(ngModel)]="day.zoneId"
                  [name]="'jour-zone-' + activeDayIndex"
                  (ngModelChange)="onJourZoneChange(activeDayIndex)"
                  [class.error]="errors['programme']">
                  <option [ngValue]="null">Selectionner une zone</option>
                  <option *ngFor="let z of zones" [ngValue]="z.idZone">{{ z.nom }}</option>
                </select>
              </div>

              <div class="form-group">
                <label>Ville du jour {{ day.jour }}</label>
                <select
                  [(ngModel)]="day.villeId"
                  [name]="'jour-ville-' + activeDayIndex"
                  (ngModelChange)="onJourVilleChange(activeDayIndex)"
                  [disabled]="!day.zoneId"
                  [class.error]="errors['programme']">
                  <option [ngValue]="null">
                    {{ isLoadingVillesForJour(activeDayIndex) ? 'Chargement...' : !day.zoneId ? 'Selectionnez une zone d abord' : 'Selectionner une ville' }}
                  </option>
                  <option *ngFor="let v of getVillesForJour(activeDayIndex)" [ngValue]="v.id">{{ v.nom }}</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <textarea
                [(ngModel)]="day.description"
                [name]="'jour-desc-' + activeDayIndex"
                rows="2"
                placeholder="Description des activites du jour..."
                [class.error]="errors['programme']"></textarea>
            </div>

            <div class="activites-selection" *ngIf="getActivitesForJour(activeDayIndex).length > 0">
              <label>Activites du jour ({{ day.activiteIds.length }} selectionnee(s))</label>
              <div class="activites-list">
                <label class="activite-item" *ngFor="let act of getActivitesForJour(activeDayIndex)">
                  <div class="activite-header">
                    <input
                      type="checkbox"
                      [checked]="isActiviteSelected(activeDayIndex, act.id)"
                      (change)="toggleActivite(activeDayIndex, act.id)">
                    <div class="activite-info">
                      <span class="activite-nom">{{ act.nom }}</span>
                      <div class="activite-meta">
                        <span class="activite-ville">{{ act.villeNom }}</span>
                        <span class="activite-duree" *ngIf="act.dureeDisplay">‚Ä¢ {{ act.dureeDisplay }}</span>
                        <span class="activite-difficulte" *ngIf="act.difficulte">‚Ä¢ {{ act.difficulte }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="activite-description" *ngIf="act.description">
                    {{ act.description }}
                  </div>
                </label>
              </div>
            </div>
            <p class="hint" *ngIf="isLoadingActivitesForJour(activeDayIndex)">
              Chargement des activites pour cette zone...
            </p>
            <p class="hint" *ngIf="!day.zoneId">
              Selectionnez une zone pour voir les activites disponibles
            </p>
            <p class="hint" *ngIf="day.zoneId && getActivitesForJour(activeDayIndex).length === 0 && !isLoadingActivitesForJour(activeDayIndex)">
              Aucune activite disponible pour cette zone
            </p>
            <span class="error-text" *ngIf="errors['programme']">{{ errors['programme'] }}</span>
          </div>
        </div>

        <div class="step3-panel" *ngIf="step3Section === 'highlights'">
          <div class="section highlights-section">
            <h3>Points forts du circuit</h3>

            <div class="predefined-points">
              <h4>Ajouter un point fort predefini</h4>
              <div class="predefined-grid">
                <button
                  type="button"
                  class="btn-predefined"
                  *ngFor="let point of predefinedPointsForts"
                  (click)="addPredefinedPointFort(point)"
                  [disabled]="circuit.pointsForts.length >= 5"
                >
                  <span class="point-icon">{{ point.icon }}</span>
                  <span class="point-title">{{ point.title }}</span>
                </button>
              </div>
            </div>

            <div class="highlights-grid">
              <div class="highlight-card" *ngFor="let point of circuit.pointsForts; let i = index; trackBy: trackByIndex">
                <div class="point-header">
                  <span class="point-number">Point fort {{ i + 1 }}</span>
                  <button type="button" class="btn-remove" (click)="removePointFort(i)" *ngIf="circuit.pointsForts.length > 1" title="Supprimer">√ó</button>
                </div>

                <div class="point-form">
                  <div class="form-row">
                    <label>Icone *</label>
                    <select
                      [(ngModel)]="circuit.pointsForts[i].icon"
                      [name]="'point-icon-' + i"
                      class="icon-select"
                    >
                      <option value="">Choisir une icone</option>
                      <option value="HISTOIRE">Histoire & Culture</option>
                      <option value="NATURE">Nature & Ecologie</option>
                      <option value="GASTRO">Gastronomie</option>
                      <option value="PLAGES">Plages & Detente</option>
                      <option value="PAYSAGES">Paysages</option>
                      <option value="TRADITIONS">Traditions</option>
                      <option value="ARTISANAT">Artisanat</option>
                      <option value="AQUATIQUE">Activites aquatiques</option>
                      <option value="PHOTO">Photographie</option>
                      <option value="RENCONTRES">Rencontres humaines</option>
                    </select>
                  </div>

                  <div class="form-row">
                    <label>Titre *</label>
                    <input
                      type="text"
                      [(ngModel)]="circuit.pointsForts[i].title"
                      [name]="'point-title-' + i"
                      placeholder="Titre du point fort"
                      class="title-input"
                    >
                  </div>

                  <div class="form-row">
                    <label>Description *</label>
                    <textarea
                      [(ngModel)]="circuit.pointsForts[i].desc"
                      [name]="'point-desc-' + i"
                      placeholder="Description detaillee du point fort"
                      rows="2"
                      class="desc-input"
                    ></textarea>
                  </div>
                </div>
              </div>

              <button type="button" class="btn-add-highlight" (click)="addPointFort()" *ngIf="circuit.pointsForts.length < 5">
                <span class="add-icon">+</span>
                <span>Creer un point fort personnalise</span>
              </button>
            </div>
          </div>
        </div>

        <div class="step3-panel" *ngIf="step3Section === 'inclusions'">
          <div class="section inclusions-section">
            <div class="inclusions-grid">
              <div class="inclusion-card included">
                <div class="inclusion-header">
                  <div class="inclusion-icon">+</div>
                  <h4>Inclus dans le prix</h4>
                </div>
                <div class="inclusion-list">
                  <div class="inclusion-item" *ngFor="let item of circuit.inclus; let i = index; trackBy: trackByIndex">
                    <span class="item-bullet"></span>
                    <input
                      type="text"
                      [(ngModel)]="circuit.inclus[i]"
                      [name]="'inclus-' + i"
                      placeholder="Ex: Guide francophone"
                      class="item-input">
                    <button type="button" class="btn-remove-small" (click)="removeInclus(i)" *ngIf="circuit.inclus.length > 1" title="Supprimer">√ó</button>
                  </div>
                  <button type="button" class="btn-add-small" (click)="addInclus()">
                    <span class="add-icon-small">+</span>
                    <span>Ajouter</span>
                  </button>
                </div>
              </div>

              <div class="inclusion-card not-included">
                <div class="inclusion-header">
                  <div class="inclusion-icon">-</div>
                  <h4>Non inclus</h4>
                </div>
                <div class="inclusion-list">
                  <div class="inclusion-item" *ngFor="let item of circuit.nonInclus; let i = index; trackBy: trackByIndex">
                    <span class="item-bullet"></span>
                    <input
                      type="text"
                      [(ngModel)]="circuit.nonInclus[i]"
                      [name]="'noninclus-' + i"
                      placeholder="Ex: Vol international"
                      class="item-input">
                    <button type="button" class="btn-remove-small" (click)="removeNonInclus(i)" *ngIf="circuit.nonInclus.length > 1" title="Supprimer">√ó</button>
                  </div>
                  <button type="button" class="btn-add-small" (click)="addNonInclus()">
                    <span class="add-icon-small">+</span>
                    <span>Ajouter</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <be-button 
          type="button" 
          variant="ghost" 
          (click)="cancel()">
          Annuler
        </be-button>

        <div class="actions-right">
          <be-button 
            type="button" 
            variant="secondary" 
            (click)="prevStep()"
            *ngIf="currentStep > 1">
            Pr√©c√©dent
          </be-button>

          <be-button 
            type="button" 
            variant="primary" 
            (click)="nextStep()"
            *ngIf="currentStep < totalSteps"
            [disabled]="!canGoNext()">
            Suivant
          </be-button>

          <be-button 
            type="submit" 
            variant="primary" 
            *ngIf="currentStep === totalSteps"
            [disabled]="loading.submit">
            {{ loading.submit ? 'Cr√©ation...' : 'Cr√©er le circuit' }}
          </be-button>
        </div>
      </div>
    </form>
  </div>
</div>




