<section class="personnalise-page">
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-overlay">
      <div class="hero-content">
        <h1>Circuit Personnalisé</h1>
        <p>Créez votre voyage sur mesure au Bénin</p>
      </div>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-step" [class.active]="etape >= 1" [class.completed]="etape > 1">
        <span class="step-number">1</span>
        <span class="step-label">Durée</span>
      </div>
      <div class="progress-step" [class.active]="etape >= 2" [class.completed]="etape > 2">
        <span class="step-number">2</span>
        <span class="step-label">Jours</span>
      </div>
      <div class="progress-step" [class.active]="etape >= 3" [class.completed]="etape > 3">
        <span class="step-number">3</span>
        <span class="step-label">Options</span>
      </div>
      <div class="progress-step" [class.active]="etape >= 4" [class.completed]="etape > 4">
        <span class="step-number">4</span>
        <span class="step-label">Résumé</span>
      </div>
      <div class="progress-step" [class.active]="etape >= 5">
        <span class="step-number">5</span>
        <span class="step-label">Contact</span>
      </div>
    </div>
  </div>

  <!-- Étape 1: Choix de la durée -->
  <div class="step-container" *ngIf="etape === 1">
    <div class="step-content">
      <h2>Combien de jours dure votre voyage ?</h2>
      <div class="duree-selector">
        <label for="nombreJours">Nombre de jours :</label>
        <select id="nombreJours" [(ngModel)]="nombreJours" (change)="changerNombreJours()">
          <option *ngFor="let n of [1,2,3,4,5,6,7,8,9,10,11,12,13,14]" [value]="n">{{ n }} jour{{ n > 1 ? 's' : '' }}</option>
        </select>
      </div>
      <div class="duree-selector">
        <label for="nombrePersonnes">Nombre de personnes :</label>
        <select id="nombrePersonnes" [(ngModel)]="nombrePersonnes">
          <option *ngFor="let n of [1,2,3,4,5,6,7,8,9,10]" [value]="n">{{ n }} personne{{ n > 1 ? 's' : '' }}</option>
        </select>
      </div>
      <div class="step-actions">
        <button class="btn-next" (click)="prochaineEtape()">Suivant</button>
      </div>
    </div>
  </div>

  <!-- Étape 2: Configuration des jours -->
  <div class="step-container" *ngIf="etape === 2">
    <div class="step-content">
      <h2>Planifiez vos journées</h2>
      <div class="jours-container">
        <div class="jour-card" *ngFor="let jour of jours; let i = index">
          <h3 class="jour-header" (click)="toggleJour(i)">
            Jour {{ jour.numero }}
            <span class="toggle-icon">{{ expanded[i] ? '−' : '+' }}</span>
          </h3>

          <div class="jour-content" *ngIf="expanded[i]">
            <!-- Sélection zone/ville -->
            <div class="zones-section">
              <h4>Zone et ville</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>Zone</label>
                  <select [(ngModel)]="jour.zoneId" (ngModelChange)="jour.villeId = null; jour.activites = []" [name]="'zone-' + i">
                    <option [ngValue]="null">Toutes les zones</option>
                    <option *ngFor="let z of zones" [ngValue]="z.idZone">{{ z.nom }}</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Ville</label>
                  <select [(ngModel)]="jour.villeId" (ngModelChange)="jour.activites = []" [name]="'ville-' + i">
                    <option [ngValue]="null">Toutes les villes</option>
                    <option *ngFor="let v of getVillesForZone(jour.zoneId)" [ngValue]="v.id">{{ v.nom }}</option>
                  </select>
                </div>
              </div>
              <p class="hint" *ngIf="jour.zoneId">
                Zone sélectionnée : {{ getZoneNames(jour) }}
              </p>
            </div>

            <!-- Sélection des activités -->
            <div class="activites-section">
              <h4>Activités (jusqu'à 5 activités)</h4>
              <p class="hint">Vous pouvez choisir au maximum 5 activités par jour, sans dépasser environ 12&nbsp;heures d'activités au total.</p>
              <div class="activites-list">
                <div class="activite-option" *ngFor="let activite of getActivitesDisponibles(i)"
                     [class.selected]="isActiviteSelected(i, activite)"
                     (click)="toggleActivite(i, activite)">
                  <div class="activite-header">
                    <h5>{{ activite.nom }}</h5>
                    <div class="activite-actions">
                      <button *ngIf="activite.image" class="btn-view-image" (click)="openImageModal(activite.image, $event)" title="Voir l'image">
                        <i class="ri-eye-line"></i>
                      </button>
                      <span class="prix" *ngIf="activite.prix != null">{{ activite.prix }}€</span>
                    </div>
                  </div>
                  <p>{{ activite.description }}</p>
                  <small>
                    <span *ngIf="activite.dureeDisplay; else dureeMinutes">{{ activite.dureeDisplay }}</span>
                    <ng-template #dureeMinutes>
                      <span *ngIf="activite.dureeMinutes">{{ activite.dureeMinutes }} min</span>
                    </ng-template>
                    <span *ngIf="activite.ville"> • {{ activite.ville }}</span>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="step-actions">
        <button class="btn-prev" (click)="etapePrecedente()">Précédent</button>
        <button class="btn-next" (click)="prochaineEtape()">Suivant</button>
      </div>
    </div>
  </div>

  <!-- Étape 3: Options générales -->
  <div class="step-container" *ngIf="etape === 3">
    <div class="step-content">
      <h2>Options pour votre circuit</h2>
      <div class="options-form">
        <div class="option-group">
          <label for="hebergement">Hébergement (Airbnb)</label>
          <select id="hebergement" [(ngModel)]="options.hebergement">
            <option value="">Choisir un Airbnb...</option>
            <option *ngFor="let h of hebergements" [value]="h.nom">
              {{ h.nom }} - {{ h.localisation }} ({{ h.prixParNuit | number:'1.0-2' }} €/nuit)
            </option>
          </select>
          <small><a href="#" (click)="voirHebergements()">Voir tous les hébergements</a></small>
        </div>

        <div class="option-group">
          <label for="transport">Transport (dépend du nombre de personnes)</label>
          <select id="transport" [(ngModel)]="options.transport">
            <option value="">Choisir...</option>
            <option *ngFor="let t of getTransportsDisponibles()" [value]="t">{{ t }}</option>
          </select>
        </div>

        <div class="option-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="options.guide">
            Guide touristique
          </label>
        </div>

        <div class="option-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="options.chauffeur">
            Chauffeur privé
          </label>
        </div>

        <div class="option-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="options.pensionComplete">
            Pension complète
          </label>
        </div>
      </div>
      <div class="step-actions">
        <button class="btn-prev" (click)="etapePrecedente()">Précédent</button>
        <button class="btn-next" (click)="prochaineEtape()">Suivant</button>
      </div>
    </div>
  </div>

  <!-- Étape 4: Résumé -->
  <div class="step-container" *ngIf="etape === 4">
    <div class="step-content">
      <h2>Résumé de votre circuit personnalisé</h2>
      <div class="resume-container">
        <div class="resume-section">
          <h3>Durée et Participants</h3>
          <p><strong>Durée :</strong> {{ nombreJours }} jour{{ nombreJours > 1 ? 's' : '' }}</p>
          <p><strong>Nombre de personnes :</strong> {{ nombrePersonnes }}</p>

          <h3>Journées <button class="btn-toggle" (click)="toggleJoursExpanded()">{{ joursExpanded ? 'Réduire' : 'Voir détails' }}</button></h3>
          <div *ngIf="joursExpanded">
            <div class="jour-resume" *ngFor="let jour of jours">
              <h4>Jour {{ jour.numero }}</h4>
              <p><strong>Zones :</strong> {{ getZoneNames(jour) }}</p>
              <div class="activites-resume" *ngIf="jour.activites.length > 0">
                <strong>Activités :</strong>
                <div class="activite-item" *ngFor="let actId of jour.activites">
                  <ng-container *ngIf="getActiviteById(actId) as act">
                    <img *ngIf="act.image" [src]="act.image" alt="{{ act.nom }}" class="activite-image" />
                    <span>{{ act.nom }}</span>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>

          <h3>Options</h3>
          <p><strong>Hébergement :</strong> <span class="hebergement-text">{{ options.hebergement || 'Non spécifié' }}</span></p>
          <p><strong>Transport :</strong> {{ options.transport || 'Non spécifié' }} <small>(dépenses dépendent du nombre de personnes)</small></p>
          <p><strong>Services :</strong>
            <span *ngIf="options.guide">Guide, </span>
            <span *ngIf="options.chauffeur">Chauffeur, </span>
            <span *ngIf="options.pensionComplete">Pension complète</span>
            <span *ngIf="!options.guide && !options.chauffeur && !options.pensionComplete">Aucun</span>
          </p>

          <h3>Prix estimé</h3>
          <p class="prix-total">{{ calculerPrixTotal() }}€ (activités uniquement)</p>
          <small>Le prix total incluant hébergement et transport sera calculé par notre équipe.</small>
        </div>
      </div>
      <div class="step-actions">
        <button class="btn-prev" (click)="etapePrecedente()">Précédent</button>
        <button class="btn-next" (click)="prochaineEtape()">Continuer</button>
      </div>
    </div>
  </div>

  <!-- Étape 5: Formulaire de contact -->
  <div class="step-container" *ngIf="etape === 5">
    <div class="step-content">
      <h2>Informations de contact</h2>
      <form class="contact-form" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <div class="form-group">
            <label for="nom">Nom *</label>
            <input type="text" id="nom" [(ngModel)]="demande.nom" name="nom" required>
          </div>
          <div class="form-group">
            <label for="prenom">Prénom *</label>
            <input type="text" id="prenom" [(ngModel)]="demande.prenom" name="prenom" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" [(ngModel)]="demande.email" name="email" required>
          </div>
          <div class="form-group">
            <label for="telephone">Téléphone *</label>
            <input type="tel" id="telephone" [(ngModel)]="demande.telephone" name="telephone" required>
          </div>
        </div>

        <div class="form-group">
          <label for="message">Message (optionnel)</label>
          <textarea id="message" [(ngModel)]="demande.message" name="message" rows="4"
                    placeholder="Dites-nous en plus sur vos préférences..."></textarea>
        </div>

        <div class="submit-actions">
          <button class="btn-prev" type="button" (click)="etapePrecedente()">Précédent</button>
          <button class="btn-submit" type="submit" [disabled]="isSubmitting">
            <span *ngIf="!isSubmitting">Envoyer ma demande</span>
            <span *ngIf="isSubmitting">Envoi en cours...</span>
          </button>
        </div>
      </form>

      <div class="success-message" *ngIf="submitSuccess">
        <h3>Demande envoyée !</h3>
        <p>Nous avons bien reçu votre demande de circuit personnalisé. Notre équipe vous contactera dans les plus brefs délais pour vous proposer un devis adapté.</p>
        <button class="btn-home" routerLink="/">Retour à l'accueil</button>
      </div>

      <div class="error-message" *ngIf="submitError">
        <p>Une erreur s'est produite lors de l'envoi. Veuillez réessayer.</p>
      </div>
    </div>
  </div>
</section>

<!-- Image Modal -->
<div class="image-modal" *ngIf="imageModalOpen" (click)="closeImageModal()">
  <div class="image-modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeImageModal()">&times;</button>
    <img *ngIf="imageModalUrl" [src]="imageModalUrl" alt="Image de l'activité" />
  </div>
</div>
